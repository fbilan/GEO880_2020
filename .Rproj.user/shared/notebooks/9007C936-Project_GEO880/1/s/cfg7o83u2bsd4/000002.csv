"0","### Load Data ###"
"0","all_stations <- st_read(file.path(""Metro/All/Stations_all_0715.shp""), quiet = TRUE)"
"0","all_stations <- st_as_sf(all_stations, coords = c(""LONG"", ""LAT""), crs = WGS84)"
"0","all_stations_sp <- all_stations %>% "
"0","  st_transform(crs = NAD83) %>%"
"0","  as(""Spatial"")"
"0",""
"0","all_stations <- st_transform(all_stations, crs = WGS84)"
"0",""
"0","biketrips <- read.csv(""bike-trips-LA-q3.csv"", sep = "","")"
"0","station_dic <- read.csv(""station_table.csv"", sep = "";"")"
"0","station_dic <- station_dic[,1:2] %>% "
"0","  mutate(Station_ID = as.character(Station_ID))"
"0",""
"0","### Clear Data ###"
"0",""
"0","# get rid of trips without coordinates and columns we don't need"
"0","biketrips <- biketrips[!is.na(biketrips$start_lat),]"
"0","biketrips <- biketrips[!is.na(biketrips$end_lat),]"
"0",""
"0","# assign character for each cluster depending on coordinates"
"0","biketrips <- biketrips %>% "
"0","  mutate(cluster_start = ifelse(start_lat > 34.1364, ""B"", ifelse(start_lat < 33.8945, ""C"", ifelse(start_lon > -118.35, ""A"", ""D""))))"
"0",""
"0","biketrips <- biketrips %>% "
"0","  mutate(cluster_end = ifelse(end_lat > 34.1364, ""B"", ifelse(end_lat < 33.8945, ""C"", ifelse(end_lon > -118.35, ""A"", ""D""))))"
"0",""
"0","## are start and end region the same? yes, only for 3 trips they are different -> focus on cluster a"
"0","biketrips <- biketrips %>% "
"0","  mutate(within = ifelse(cluster_start == cluster_end, TRUE, FALSE))"
"0",""
"0","# add hour, day, month and time to data set and adjust data types"
"0","biketrips <- biketrips %>% "
"0","  mutate(start_time=as.POSIXct(start_time, format=""%m/%d/%Y %H:%M"")) %>%"
"0","  mutate(start_hour = as.POSIXlt(start_time)$hour) %>%"
"0","  mutate(start_day=floor_date(start_time, unit=""day"")) %>% "
"0","  mutate(start_month=floor_date(start_time, unit=""month"")) %>% "
"0","  mutate(end_time=as.POSIXct(end_time, format=""%m/%d/%Y %H:%M"")) %>%"
"0","  mutate(end_hour = as.POSIXlt(end_time)$hour) %>%"
"0","  mutate(end_day=floor_date(end_time, unit=""day"")) %>% "
"0","  mutate(end_month=floor_date(end_time, unit=""month"")) %>%"
"0","  mutate(start_station = as.character(start_station)) %>%"
"0","  mutate(end_station = as.character(end_station)) %>%"
"0","  mutate(start_lon = as.numeric(start_lon)) %>%"
"0","  mutate(start_lat = as.numeric(start_lat)) %>%"
"0","  mutate(end_lon = as.numeric(end_lon)) %>%"
"0","  mutate(end_lat = as.numeric(end_lat))"
"0",""
"0","# calculate distance and velocity (convert to NAD83 and use pythagoras) and bind it to biketrips"
"0","biketrips_duration <- biketrips %>% "
"0","  group_by(duration) %>%"
"0","  summarize(count=n())"
"0",""
"0","biketrips <- biketrips %>% "
"0","  filter(duration > 0, duration < 1430)"
"0",""
"0","biketrips_start <- biketrips[c(""start_lon"", ""start_lat"")] %>% "
"0","  st_as_sf(coords = c(""start_lon"", ""start_lat""), crs = WGS84) %>%"
"0","  st_transform(crs = NAD83)"
"0",""
"0","biketrips_end <- biketrips[c(""end_lon"", ""end_lat"")] %>% "
"0","  st_as_sf(coords = c(""end_lon"", ""end_lat""), crs = WGS84) %>% "
"0","  st_transform(crs = NAD83)"
"0",""
"0","biketrips_dist <- st_coordinates(biketrips_start) %>% "
"0","  cbind(st_coordinates(biketrips_end))"
"0",""
"0","colnames(biketrips_dist) <- c(""x1"", ""y1"", ""x2"", ""y2"")"
"0","biketrips_dist <- as.data.frame(biketrips_dist) %>% "
"0","  mutate(distance = sqrt((x1-x2)**2 + (y1-y2)**2)/1000)"
"0","biketrips <- biketrips %>% "
"0","  cbind(distance = biketrips_dist$distance) %>% "
"0","  mutate(velocity = distance / duration*60)"
"0",""
"0","# create sf object"
"0","bike_start_sf <- biketrips %>% "
"0","  st_as_sf(coords = c(""start_lon"", ""start_lat""), crs = WGS84)"
"0",""
"0","biketrips_a <- biketrips %>% "
"0","  filter(cluster_start == ""A"" & within == TRUE)"
